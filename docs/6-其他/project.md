# 大屏设计器

## 权限管理

### 页面路由权限

权限管理，在页面权限方面采用路由标记，在配置路由的时候给路由对象增加一个标记，用来表示那些角色可以访问该路由，用数组表示，比如

```js
{
    path: '/home',
    name: 'home',
    component: Home,
    meta: {
        roles: ['admin', 'editor']
    }
}
```

在路由切换的时候，根据当前用户的角色，判断该用户是否有权限访问该路由，如果没有权限，则跳转到403页面。

对于管理页面的菜单数据，采用 `vuex` 封装一个`getters` 属性，根据当前用户的角色以及路由数组，生成当前角色的菜单数据。

### 按钮权限

按钮权限，在页面中，根据当前用户的角色，判断该用户是否有权限访问该按钮，如果没有权限，则隐藏该按钮。技术上采用的是自定义指令和状态管理保存的当前用户角色相结合，判断按钮是否应该展示

```js
<el-button v-permission="['admin']">编辑</el-button>
```

### 需求变化

需求变化了，单单通过角色来判断权限是不够的，因为当权限具体到一些模块的可见、增删查改操作的控制的时候就不好控制了，比如角色`admin` 和 `user` 都可以控制某个列表的可见，但是 `admin` 有增删改的所有权限，而 `user`只有查看的权限，这时候怎么控制增删改的权限就不好控制了。

所以，后来修改了权限控制系统，在角色的基础上，增加了模块，以及模块的操作（如增删改）。模块可以指某个页面，通常为列表，操作通常为增删改。这样就可以给每个角色分配不同的模块和不同的操作了。数据可以表现为：

```json
{
  // admin 角色
  "admin": {
    // 模块 userTable
    "userTable": ["*"], // 拥有模块所有的操作
    // 模块 table2
    "table2": ["*"]
  },
  // user 角色
  "user": {
    // 模块 userTable
    "userTable": ["query"], // 只拥有查看操作
    // 模块 table2
    "table2": ["query"] // 只拥有查看操作
  }
}
```

技术上使用的是 `acl` 库，通过 `acl.can` 方法来判断当前用户是否有权限访问该模块的操作。关键代码如下：

定义角色和模块
```js
app.acl.allow([
  {
    roles: ['admin'],
    allows: [
      { resources: 'userTable', permissions: ['*'] },
      { resources: 'table2', permissions: ['*'] },
    ],
  },
  {
    roles: ['user'],
    allows: [
      { resources: 'userTable', permissions: ['query'] },
      { resources: 'table2', permissions: ['query'] },
    ],
  },
]);
```

判断当前用户是否有权限访问该模块的操作
```js
let roleList = ['admin', 'guest']
;(async () => {
  let permissions = await acl.whatResources(roleList)
  console.log('permissions', permissions)
})()

```

## 大屏获取数据优化 `EventSource`
## 文件上传优化
## 集成 `swagger-egg` 自动生成接口文档
## 自动截图


# 金智维宣传平台

## 双 `token` 刷新
## 多语言
期初项目还没有多语言的需求，所以没有进行多语言的配置。因此很多页面都是对中文进行了定制化的。这不仅带来的实现方案的确定以及重构成本。当然后来技术上使用的是`i18n` 库，利用它实现了多语言的模板。由于当时这个 `i18n` 对我而言也是个新东西，所以我花了不少时间去调研。

当然，使用了`i18n` 之后，需要定制语言模板，然后重构页面代码，把文字模板都替换成`i18n` 模板表达式就行了，再配合`vuex`状态管理绑定 `i18n` 当前语言环境。

在体验上也做了一些优化，比如利用 `localstroage` 做了语言本地持久化，记录用户习惯的语言，避免下次使用时还需要手动切换。

不是为了说这个东西很难，只是想说有些东西开头很难，只要肯花些时间去琢磨，最后你都会发现其实也就那样。

## 服务端渲染方案
## SEO 优化
## 百度地图
## 手机和邮箱验证
这个项目有一个后台管理系统，用来管理文章内容和资源文件的，登录需要手机和邮箱验证。手机验证码使用的`聚合数据`提供的`api`。也不是说为了说这个点很难，只是当时我需要兼顾前后端的开发，所以如何实现手机验证码，以及如何在前端实现手机验证码的输入，都是我需要考虑的问题。因为当时对我来说也是全新的东西。需要学习`api`的使用，以及如何在前端实现手机验证码的输入。所以在调研方面加了好几天班研究，这不仅仅是后端还有前端。

**聚合数据短信 `api` 的使用大概如下**
1. 注册账号（公司已有），申请短信验证码API，并获取 `请求key`
2. 创建短信模板，并获取模板 ID
3. 调用`api`发送短信

**使用手机验证码登录的过程**
1. 首先用于输入手机号，并发送验证码。为了避免用户频繁点击发送验证码操作导致白白消耗掉 `api` 的次数，前、后端都做了80秒后重发的限制。
2. 输入验证码，并登录，手机号和验证码一起发送到后端，后端验证手机号和验证码是否匹配。
3. 登录成功后，后端返回一个 `token`，前端将 `token` 存储到本地，后续的请求，都会携带这个 `token`。

其中后端80秒重试的做法是，调用`api` 的到验证码后，把手机号和对应验证码存到哈希表中，并设置一个80秒的过期时间。


## 腾讯云对象存储 `sdk`
## 集成 swagger 自动生成接口文档
